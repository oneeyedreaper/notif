// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  phone               String?   @unique
  password            String
  name                String
  
  // Email verification
  emailVerified       Boolean   @default(false)
  emailVerifyToken    String?
  emailVerifyExpires  DateTime?
  
  // Phone verification  
  phoneVerified       Boolean   @default(false)
  phoneVerifyCode     String?
  phoneVerifyExpires  DateTime?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  notifications Notification[]
  preferences   UserPreference?

  @@map("users")
}

// Notification types enum
enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
}

// Priority levels enum
enum Priority {
  LOW
  MEDIUM
  HIGH
}

// Notification model
model Notification {
  id          String           @id @default(cuid())
  userId      String
  type        NotificationType @default(INFO)
  priority    Priority         @default(MEDIUM)
  title       String
  message     String
  actionUrl   String?
  metadata    Json?
  isRead      Boolean          @default(false)
  readAt      DateTime?
  scheduledAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs NotificationLog[]

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([userId, type])
  @@map("notifications")
}

// Template channel enum
enum TemplateChannel {
  EMAIL
  SMS
}

// Template model for email/SMS templates
model Template {
  id        String          @id @default(cuid())
  name      String          @unique
  channel   TemplateChannel
  subject   String?         // For email templates
  body      String
  variables String[]        // List of variable names like ["name", "message"]
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@map("templates")
}

// User notification preferences
model UserPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  emailEnabled      Boolean  @default(true)
  smsEnabled        Boolean  @default(false)
  pushEnabled       Boolean  @default(true)
  emailFrequency    String   @default("instant") // instant, daily, weekly
  quietHoursStart   String?  // HH:mm format
  quietHoursEnd     String?  // HH:mm format
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// Delivery status enum
enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

// Notification delivery log
model NotificationLog {
  id             String         @id @default(cuid())
  notificationId String
  channel        TemplateChannel
  status         DeliveryStatus @default(PENDING)
  recipient      String         // email or phone number
  templateId     String?
  errorMessage   String?
  sentAt         DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@index([status])
  @@map("notification_logs")
}
